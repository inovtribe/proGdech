{% extends 'GeographProgdechBundle:Backend:backend_layout.html.twig' %}
{% set adminMenu = true %}

{% block title %}Détail d'un point de collecte{% endblock %}

{% block content %}
<h2>{{ block('title') }}</h2>
{% for flashMessage in app.session.flashbag.get('success') %}
<div class="alert alert-success">
    {{ flashMessage }}
</div>
{% endfor %}
<div class="row">
    <div class="col-md-6">
        <h3>{{ pointcollecte.nom }}</h3>
        <p>{{ pointcollecte.reference }}</p>
        <p>{{ pointcollecte.adresse }}</p>
        <p><a href="{{ app.request.basepath }}/admin/commune/{{ pointcollecte.commune.insee }}">{{ pointcollecte.commune.nom }}</a></p>
        <p>Nombre d'emplacements : {{ pointcollecte.emplacement }} (points de colelctes affectés affecté(s) | points de colelcte emplacements vides disponible(s))</p>
        <p>Créé le date par <a href="{{ app.request.basepath }}/admin/user/{{ pointcollecte.user.id }}">{{ pointcollecte.user.prenom }} {{ pointcollecte.user.nom }}</a></p>
    </div>
    <div class="col-md-6">
        <div id="map" class="h400"></div>
    </div>
    {% autoescape %}
        <script>
            var geojson = L.geoJson(gestionnairelayer);
            geojson.setStyle({"color": 'red', "weight": 1, "fill" : true, smoothFactor: 1, "fillOpacity": 0.025});
            
            var topo = L.tileLayer('{{ topolayer.url|raw }}', {attribution: '{{ topolayer.attribution|raw }}'});
            var aerial = L.tileLayer("{{ aeriallayer.url|raw }}", {attribution: "{{ aeriallayer.attribution|raw }}"});
            var baseMaps = {"Carte": topo, "Vue aerienne": aerial};
            var overlayMaps = {};
            var map = L.map('{{ carte.div|raw }}', {center: [{{ carte.latitudeview|raw }}, {{ carte.longitudeview|raw }}], zoom: {{ carte.zoom|raw }}, layers: [topo, geojson]});
            L.control.layers(baseMaps, overlayMaps).addTo(map);
            
            commune = L.geoJson(geometriescommunales, {
                filter: filtre, style: {
                fillColor: 'blue',
                fillOpacity: 0.15,
                weight: 1,
                opacity: 1,
                color: 'blue',
                dashArray: '1'}}).addTo(map); 
            
            markeractif = L.icon({
                iconUrl: '    {{ markeractif.filename|raw }}',
                iconSize:     {{ markeractif.size|raw }},
                iconAnchor:   {{ markeractif.anchor|raw }},
                popupAnchor:  {{ markeractif.popupanchor|raw }}
            });
                
            geojson = L.geoJson(geometriescommunales, {style: style, onEachFeature: onEachFeature,}).addTo(map);
            
            marker = L.marker([{{ pointcollecte.latitude }}, {{ pointcollecte.longitude }}], {icon: markeractif}).addTo(map);
            
            map.fitBounds(commune.getBounds()).setMaxBounds(marker.getBounds());
            
            function style(feature) {
                return { 
                    weight: 1,
                    opacity: 0.5,
                    color: 'green',
                    dashArray: '3',
                    fillOpacity: 0.0
                };
            }
            function filtre(feature, layer) {
                return feature.properties.INSEE == {{ commune.insee }};
            }
            function highlightFeature(e, feature, layer) {
                var layer = e.target;

                layer.setStyle({
                    weight: 2,
                    color: 'green',
                    dashArray: '',
                    fillOpacity: 0.15
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }
                $("#donneescommune").text(/*Variable du nom de la commune*/);
            }
            function resetHighlight(e) {
                geojson.resetStyle(e.target);
                $("#donneescommune").text("Survolez une commune");
            }
            function zoomToFeature(e) {
                //map.fitBounds(e.target.getBounds());
                var layer = e.target;
                var inseecommune = layer.feature.properties.INSEE;
                document.location.href = "{{ app.request.basepath }}/admin/commune/" + inseecommune;
            }
            function onEachFeature(feature, layer) {
                layer.bindLabel(layer.feature.properties.COMMUNE);
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }
        </script>
    {% endautoescape %}

</div>

{% endblock %}